---
title: æœºå™¨å­¦ä¹ å¯è§£é‡Šæ€§ä¹‹éƒ¨åˆ†ä¾èµ–å›¾ Partial Dependence Plots
date: 2019-03-19 17:50:02
tags: [æœºå™¨å­¦ä¹ ]
categories: æŠ€æœ¯
index_img: https://raw.githubusercontent.com/Waynehfut/blog/img/img/20220722173741.png
---
æœ¬ç¯‡ç¿»è¯‘è‡ªKaggleæœºå™¨å­¦ä¹ å¯è§£é‡Šæ€§å¾®å…¬å¼€è¯¾ğŸ“ï¼Œæœ¬ç¯‡æ—¶ç¬¬ä¸‰è¯¾æ—¶ï¼Œä¸»è®²åˆ©ç”¨éƒ¨åˆ†ä¾èµ–å‘ç°æ•°æ®å¦‚ä½•å½±å“é¢„æµ‹

<!-- more -->

Check source at [Kaggle](https://www.kaggle.com/learn/machine-learning-explainability) by Dan Becker, translate by [waynehfut](https://waynehfut.com/)

# éƒ¨åˆ†ä¾èµ–å›¾

æ’åˆ—é‡è¦æ€§å±•ç¤ºäº†å“ªäº›å˜é‡æœ€å®¹æ˜“å½±å“é¢„æµ‹ç»“æœï¼Œè€Œéƒ¨åˆ†ä¾èµ–å›¾åˆ™æ˜¯å±•ç¤ºäº†ç‰¹å¾å¦‚ä½•å½±å“æœ€ç»ˆé¢„æµ‹ç»“æœã€‚

è¿™é¡¹æ‰‹æ®µå¯¹äºå›ç­”ä¸‹åˆ—é—®é¢˜ååˆ†æœ‰åˆ©ï¼š

- åœ¨å›ºå®šä½å…¶ä»–æˆ¿å±‹ç›¸å…³çš„ç‰¹å¾åï¼Œç»åº¦å’Œçº¬åº¦å¯¹æˆ¿ä»·ä¼šæœ‰ä»€ä¹ˆæ ·çš„å½±å“ï¼Ÿé‡ç”³è¿™ä¸€ç‚¹ï¼Œå³ä¸ºåœ¨ä¸åŒä½ç½®æˆ¿å­åº”è¯¥å¦‚ä½•å®šä»·ï¼Ÿ
- é¢„æµ‹ä¸¤ç»„äººç¾¤çš„å¥åº·å·®å¼‚ä¸»è¦æ˜¯ç”±äºé¥®é£Ÿä¹ æƒ¯è¿˜æ˜¯å…¶ä»–çš„å› ç´ ï¼Ÿ

å¦‚æœä½ å¯¹çº¿æ€§å›å½’å’Œé€»è¾‘å›å½’æ¨¡å‹å¾ˆç†Ÿæ‚‰ï¼Œéƒ¨åˆ†ä¾èµ–å›¾å¯ä»¥ç”¨æ¨¡å‹ä¸­ç›¸ä¼¼çš„ç³»æ•°æ¥è§£é‡Šã€‚ä½†æ˜¯ï¼Œå¤æ‚æ¨¡å‹çš„éƒ¨åˆ†ä¾èµ–å›¾å¯ä»¥æ•è·åˆ°æ¯”ç®€å•æ¨¡å‹ä¸­ç³»æ•°æ›´ä¸ºå¤æ‚çš„æ¨¡å¼ã€‚å¦‚æœä½ å¯¹çº¿æ€§å›å½’å’Œé€»è¾‘å›å½’ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒè¿™äº›æ¯”è¾ƒã€‚

æˆ‘ä»¬å°†å±•ç¤ºä¸€ç³»åˆ—ä»£ç ï¼Œè§£é‡Šè¿™äº›å›¾çš„èƒŒåæ¶µä¹‰ï¼Œä¹‹åå®¡æŸ¥ä»£ç ä»¥ä¾¿äºåæœŸåˆ›å»ºè¿™äº›å›¾

# å¦‚ä½•ç”Ÿæ•ˆ

å°±åƒæ’åˆ—é‡è¦æ€§ï¼Œ**éƒ¨åˆ†ä¾èµ–å›¾åœ¨æ¨¡å‹è®­ç»ƒå®Œæ¯•åæ‰è¿›è¡Œè®¡ç®—**ã€‚è¿™äº›æ¨¡å‹åœ¨çœŸå®æ•°æ®ä¸­è°ƒä¼˜åŒæ—¶æ²¡æœ‰ä»¥å…¶ä»–ä»»ä½•æ–¹å¼è¿›è¡Œäººä¸ºä¿®æ”¹ã€‚

åœ¨æˆ‘ä»¬ä¹‹å‰æåˆ°çš„è¶³çƒä¾‹å­ä¸­ï¼Œé˜Ÿä¼ä¹‹é—´æœ‰è¯¸å¤šçš„ä¸åŒã€‚å¦‚ï¼šè¿‡äº†å¤šå°‘ä¸ªäººï¼Œå°„é—¨å¤šå°‘æ¬¡ï¼Œè®°å½•çš„è¿›çƒç­‰ã€‚ä¹ä¸€çœ‹ä¼¼ä¹å¾ˆéš¾è§£å¼€å…¶ä¸­è¿™äº›ç‰¹å¾å¯¹æœ€åç»“æœçš„å½±å“ã€‚

è¦æŸ¥çœ‹éƒ¨åˆ†å›¾å¦‚ä½•åˆ†ç¦»æ¯ä¸ªè¦ç´ çš„æ•ˆæœï¼Œæˆ‘ä»¬é¦–å…ˆè€ƒè™‘å•åˆ—æ•°æ®ã€‚ä¾‹å¦‚ï¼Œä¸€åˆ—æ•°æ®å¯èƒ½å±•ç¤ºäº†50%çš„æ§çƒç‡ï¼Œ100æ¬¡è¿‡äººï¼Œ10æ¬¡å°„é—¨å’Œ1æ¬¡è¿›çƒã€‚

æˆ‘ä»¬å°†ä½¿ç”¨å·²ç»è®­ç»ƒå¥½çš„æ¨¡å‹å»é¢„æµ‹å¯èƒ½çš„ç»“æœï¼ˆè·å¾—"æœ€ä½³çƒå‘˜"çš„æ¦‚ç‡ï¼‰ã€‚ä½†æˆ‘ä»¬**åå¤æ”¹å˜ä¸€ä¸ªå˜é‡çš„å€¼æ¥è¿›è¡Œä¸€ç³»åˆ—çš„é¢„æµ‹**ã€‚æˆ‘ä»¬å¯ä»¥é¢„æµ‹é˜Ÿä¼æ§çƒ40%æ—¶çš„ç»“æœï¼Œä¹‹åé¢„æµ‹æ§çƒ50%æ—¶çš„ç»“æœï¼Œä»¥åŠåœ¨60%æ—¶çš„ç»“æœï¼Œç­‰ç­‰ã€‚æˆ‘ä»¬è¿½è¸ªæ§çƒç‡ï¼ˆæ¨ªè½´ï¼‰ä»å°åˆ°å¤§å˜åŒ–æ—¶çš„é¢„æµ‹ç»“æœï¼ˆçºµè½´ï¼‰ã€‚

åŸºäºä¸Šè¿°æè¿°ï¼Œæˆ‘ä»¬ä»…ä½¿ç”¨ä¸€åˆ—æ•°æ®ã€‚ç‰¹å¾ä¹‹é—´çš„ç›¸äº’å½±å“å¯èƒ½ä¼šé€ æˆå•åˆ—å›¾å¼‚å¸¸ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨åŸå§‹æ•°æ®é›†ä¸­çš„å¤šè¡Œä¸æ–­çš„é‡å¤è¿™ä¸ªå¿ƒç†å®éªŒï¼Œä¹‹åæˆ‘ä»¬åœ¨å‚ç›´åæ ‡ä¸Šç”»å‡ºå¹³å‡é¢„æµ‹ç»“æœã€‚

# ä»£ç ç¤ºä¾‹

å»ºç«‹æ¨¡å‹ä»ç„¶ä¸æ˜¯æˆ‘ä»¬å…³æ³¨çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¸å»å…³æ³¨æ•°æ®æ¢ç´¢æˆ–è€…æ˜¯æ¨¡å‹å»ºç«‹çš„ä»£ç ã€‚

```python
import numpy as np
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.tree import DecisionTreeClassifier

data = pd.read_csv('../input/fifa-2018-match-statistics/FIFA 2018 Statistics.csv')
y = (data['Man of the Match'] == "Yes")  # å°†"Yes"/"No"å­—ç¬¦ä¸²è½¬æ¢ä¸ºäºŒå€¼
feature_names = [i for i in data.columns if data[i].dtype in [np.int64]]
X = data[feature_names]
train_X, val_X, train_y, val_y = train_test_split(X, y, random_state=1)
tree_model = DecisionTreeClassifier(random_state=0, max_depth=5, min_samples_split=5).fit(train_X, train_y)
```

ä¸ºäº†ä¾¿äºè§£é‡Šï¼ˆFor the sake of explanation)ï¼Œæˆ‘ä»¬ç¬¬ä¸€ä¸ªä¾‹å­ä½¿ç”¨ä½ å¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°çš„å†³ç­–æ ‘ã€‚åœ¨å®è·µä¸­ï¼Œä½ å°†éœ€è¦é€‚ç”¨äºçœŸæ˜¯ä¸–ç•Œä¸­æ›´åŠ å¤æ‚çš„æ¨¡å‹ã€‚

```python
from sklearn import tree
import graphviz

tree_graph = tree.export_graphviz(tree_model, out_file=None, feature_names=feature_names)
graphviz.Source(tree_graph)
```
![p1](https://raw.githubusercontent.com/Waynehfut/blog/img/img/202207231610374.png)

ç†è§£è¿™æ£µæ ‘ï¼š

- æœ‰å­©å­èŠ‚ç‚¹çš„å¶å­èŠ‚ç‚¹åœ¨é¡¶éƒ¨å±•ç¤ºäº†åˆ†å‰²æ ‡å‡†ã€‚
- åº•éƒ¨çš„å€¼å¯¹åˆ†åˆ«æ˜¾ç¤ºäº†æ ‘çš„è¯¥èŠ‚ç‚¹ä¸­æ•°æ®ç¬¦åˆåˆ†å‰²æ ‡å‡†çš„çœŸå€¼å’Œå‡å€¼å¾—æ•°é‡

æ¥ä¸‹æ¥æ˜¯ä½¿ç”¨[PDPBox library](https://pdpbox.readthedocs.io/en/latest/)åˆ›å»ºéƒ¨åˆ†ä¾èµ–å›¾çš„ä»£ç 

```python
from matplotlib import pyplot as plt
from pdpbox import pdp, get_dataset, info_plots

# åˆ›å»ºéœ€è¦ç»˜å›¾çš„æ•°æ®
pdp_goals = pdp.pdp_isolate(model=tree_model, dataset=val_X, model_features=feature_names, feature='Goal Scored')

# ç»˜å›¾
pdp.pdp_plot(pdp_goals, 'Goal Scored')
plt.show()
```
![p2](https://raw.githubusercontent.com/Waynehfut/blog/img/img/202207231610251.png)

åœ¨è§£é‡Šè¿™ä¸ªå›¾æ—¶ï¼Œæœ‰ä¸€äº›å€¼å¾—æ³¨æ„çš„ç‚¹ã€‚

- yè½´ç”¨ä»¥è§£é‡Šé¢„æµ‹ä¸­ä»åŸºçº¿æˆ–æœ€å·¦è¾¹å€¼é¢„æµ‹çš„å˜åŒ–
- è“è‰²é˜´å½±è¡¨ç¤ºäº†ç½®ä¿¡åº¦

å¯¹äºè¿™ä¸ªç‰¹å®šçš„å›¾è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºä¸€æ¬¡è¿›çƒæ•°èƒ½å¤Ÿå¤§å¤§çš„å¢åŠ ä½ è·å¾—â€œæœ€ä½³çƒå‘˜â€çš„æœºä¼šã€‚ä½†æ˜¯é¢å¤–çš„è¿›çƒå¯¹äºé¢„æµ‹è€Œè¨€å¹¶æ²¡æœ‰å¤ªå¤šçš„å½±å“ã€‚

è¿™é‡Œæ˜¯å¦ä¸€ä¸ªä¾‹å›¾ï¼š

```python
feature_to_plot = 'Distance Covered (Kms)'
pdp_dist = pdp.pdp_isolate(model=tree_model, dataset=val_X, model_features=feature_names, feature=feature_to_plot)

pdp.pdp_plot(pdp_dist, feature_to_plot)
plt.show()
```
![p3](https://raw.githubusercontent.com/Waynehfut/blog/img/img/202207231610440.png)

è¿™ä¸ªå›¾ä¼¼ä¹è¿‡äºç®€å•è€Œæ— æ³•è¡¨ç°å‡ºçœŸå®ç°è±¡ã€‚å®è´¨ä¸Šæ˜¯æ¨¡å‹å¤ªè¿‡ç®€å•äº†ï¼Œä½ åº”è¯¥å¯ä»¥ä»ä¸Šé¢çš„å†³ç­–æ ‘å‘ç°è¿™ä¸ªå®é™…ä¸Šä»£è¡¨äº†æ¨¡å‹çš„ç»“æ„ï¼ˆwaynehfutæ³¨ï¼š101.5kmä¸ºèŠ‚ç‚¹ï¼‰

ä½ å¯ä»¥å¾ˆå®¹æ˜“çš„æ¯”è¾ƒä¸åŒæ¨¡å‹çš„ç»“æ„å’Œæ¶µä¹‰ï¼Œè¿™é‡Œæä¾›äº†ä¸€ä¸ªéšæœºæ£®æ—æ¨¡å‹çš„ç¤ºä¾‹å›¾ã€‚

```python
# æ„å»ºéšæœºæ£®æ—æ¨¡å‹
rf_model = RandomForestClassifier(random_state=0).fit(train_X, train_y)

pdp_dist = pdp.pdp_isolate(model=rf_model, dataset=val_X, model_features=feature_names, feature=feature_to_plot)

pdp.pdp_plot(pdp_dist, feature_to_plot)
plt.show()
```

![p4](https://raw.githubusercontent.com/Waynehfut/blog/img/img/202207231610466.png)

è¿™ä¸ªæ¨¡å‹è®¤ä¸ºä½ å¦‚æœè·‘åŠ¨è¶…è¿‡100kmçš„è¯ï¼Œæ›´æœ‰å¯èƒ½è·å¾—æœ€ä½³çƒå‘˜ã€‚è™½ç„¶è·‘çš„æ›´å¤šå¯¼è‡´äº†æ›´ä½çš„é¢„æµ‹ç»“æœã€‚

é€šå¸¸ï¼Œè¿™ä¸ªæ›²çº¿çš„å¹³æ»‘å½¢çŠ¶ä¼¼ä¹æ¯”å†³ç­–æ ‘æ¨¡å‹ä¸­çš„é˜¶æ¢¯å‡½æ•°æ›´åˆç†ã€‚å› ä¸ºè¿™ä¸ªæ•°æ®é›†è¶³å¤Ÿå°å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨è§£é‡Šæ¨¡å‹æ—¶å°å¿ƒç¿¼ç¿¼çš„å¤„ç†ã€‚

# 2Dçš„éƒ¨åˆ†ä¾èµ–å›¾

å¦‚æœä½ å…³å¿ƒç‰¹å¾é—´çš„ç›¸äº’å½±å“ï¼Œé‚£ä¹ˆäºŒç»´çš„éƒ¨åˆ†ä¾èµ–å›¾å°†ä¼šå¾ˆæœ‰ç”¨ï¼Œä¸€ä¸ªä¾‹å­å¯ä»¥è¯´æ˜æ¸…æ¥šè¿™ä¸ªæ˜¯ä»€ä¹ˆã€‚

æˆ‘ä»¬å¯¹äºè¿™ä¸ªå›¾ä»ç„¶ä½¿ç”¨å†³ç­–æ ‘ã€‚ä»–å°†æ„å»ºä¸€ä¸ªéå¸¸ç®€å•çš„å›¾ï¼Œä½†æ˜¯ä½ åº”å½“å¯ä»¥å°†è¿™ä¸ªå›¾ä¸åŸæ¥çš„å†³ç­–æ ‘è¿›è¡ŒåŒ¹é…ã€‚

```python
# ä¸å‰æ–‡çš„éƒ¨åˆ†ä¾èµ–å›¾ç›¸ä¼¼ï¼Œæˆ‘ä»¬ä½¿ç”¨pdp_interactæ›¿æ¢äº†pdp_isolate,pdp_interact_plotæ›¿æ¢äº†pdp_isolate_plot
features_to_plot = ['Goal Scored', 'Distance Covered (Kms)']
inter1  =  pdp.pdp_interact(model=tree_model, dataset=val_X, model_features=feature_names, features=features_to_plot)

pdp.pdp_interact_plot(pdp_interact_out=inter1, feature_names=features_to_plot, plot_type='contour')
plt.show()
```
ç»“æœå¦‚ä¸‹ï¼š
![p5](https://raw.githubusercontent.com/Waynehfut/blog/img/img/202207231611350.png)

è¿™ä¸ªå›¾å±•ç¤ºäº†ä»»æ„è¿›å¾—åˆ†å’Œè¦†ç›–è·ç¦»ç»„åˆå¯èƒ½çš„é¢„æµ‹ç»“æœ

ä¾‹å¦‚ï¼Œæˆ‘ä»¬çœ‹åˆ°æœ€é«˜é¢„æµ‹ç»“æœå‡ºç°åœ¨è‡³å°‘è¿›äº†ä¸€çƒå¹¶è·‘åŠ¨æ¥è¿‘100kmçš„æ—¶å€™ã€‚å¦‚æœæ²¡æœ‰è¿›çƒï¼Œè¦†ç›–è·ç¦»ä¹Ÿæ— å…³ç´§è¦äº†ã€‚ä½ èƒ½å¤Ÿé€šè¿‡è¿½è¸ª0è¿›çƒçš„å†³ç­–æ ‘æ¥çœ‹åˆ°è¿™ä¸€ç‚¹å—ï¼Ÿ

ä½†æ˜¯ï¼Œå¦‚æœä»–ä»¬è·å¾—è¿›çƒï¼Œè·ç¦»ä¼šå½±å“é¢„æµ‹ã€‚ç¡®ä¿æ‚¨å¯ä»¥ä»2Déƒ¨åˆ†ä¾èµ–å›¾ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚ä½ èƒ½åœ¨å†³ç­–æ ‘ä¸­çœ‹åˆ°è¿™ç§æ¨¡å¼å—ï¼Ÿ